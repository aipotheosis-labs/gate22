name: Backend ECS Deployment
on:
  workflow_dispatch: # For manual deployment
  push:
    branches:
      - chore/adding-cicd-for-ecs-deployment
    # tags:
    #   - "*.*.*"
    # TODO: consider only trigger on main branch?

jobs:
  build-control-plane:
    name: Build and Push Control Plane
    uses: ./.github/workflows/ecs-build.yml
    secrets: inherit
    with:
      ecr_repository_url: ${{ vars.CICD_ECR_REPOSITORY_URL_CONTROL_PLANE }}
      image_tag: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
      dockerfile: Dockerfile.control_plane

  # build-mcp:
  #   name: Build and Push MCP
  #   uses: ./.github/workflows/ecs-deployment/build.yml
  #   with:
  #     ecr_repository_url: ${{ env.ECR_REPOSITORY_URL_MCP }}
  #     image_tag: ${{ env.IMAGE_TAG }}
  #     dockerfile: Dockerfile.mcp

  # build-runner:
  #   name: Build and Push Runner
  #   uses: ./.github/workflows/ecs-deployment/build.yml
  #   with:
  #     ecr_repository_url: ${{ env.ECR_REPOSITORY_URL_RUNNER }}
  #     image_tag: ${{ env.IMAGE_TAG }}
  #     dockerfile: Dockerfile.runner

  deploy-control-plane:
    name: Deploy Control Plane
    needs: [build-control-plane]
    uses: ./.github/workflows/ecs-deploy.yml
    secrets: inherit
    with:
      ecs_task_definition: ${{ vars.CICD_ECS_TASK_DEFINITION_CONTROL_PLANE }}
      ecs_service: ${{ vars.CICD_ECS_SERVICE_CONTROL_PLANE }}
      ecs_cluster: ${{ vars.CICD_ECS_CLUSTER }}
      ecr_repository_url: ${{ vars.CICD_ECR_REPOSITORY_URL_CONTROL_PLANE }}
      image_tag: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}

  # deploy-mcp:
  #   name: Deploy MCP
  #   needs: [build-mcp]
  #   uses: ./.github/workflows/ecs-deployment/deploy.yml
  #   with:
  #     ecs_task_definition: ${{ env.ECS_TASK_DEFINITION_MCP }}
  #     ecs_service: ${{ env.ECS_SERVICE_MCP }}
  #     ecs_cluster: ${{ env.ECS_CLUSTER }}
  #     ecr_repository_url: ${{ env.ECR_REPOSITORY_URL_MCP }}
  #     image_tag: ${{ env.IMAGE_TAG }}
